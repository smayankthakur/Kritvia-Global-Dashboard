generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  CEO
  OPS
  SALES
  FINANCE
  ADMIN
}

enum ActivityEntityType {
  AUTH
  USER
  POLICY
  COMPANY
  CONTACT
  LEAD
  DEAL
  WORK_ITEM
  INVOICE
}

enum LeadStage {
  NEW
  QUALIFIED
  DISQUALIFIED
}

enum DealStage {
  OPEN
  WON
  LOST
}

enum WorkItemStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  DONE
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
}

enum NudgeStatus {
  OPEN
  RESOLVED
}

enum NudgeType {
  MANUAL
  OVERDUE_INVOICE
  OVERDUE_WORK
  STALE_DEAL
}

enum NudgeSeverity {
  MEDIUM
  HIGH
  CRITICAL
}

model Org {
  id           String        @id @default(uuid()) @db.Uuid
  name         String
  createdAt    DateTime      @default(now()) @map("created_at")
  users        User[]
  policies     Policy[]
  activityLogs ActivityLog[]
  companies    Company[]
  contacts     Contact[]
  leads        Lead[]
  deals        Deal[]
  workItems    WorkItem[]
  invoices     Invoice[]
  nudges       Nudge[]
  refreshTokens RefreshToken[]
  healthSnapshots OrgHealthSnapshot[]
  securityEvents SecurityEvent[]

  @@map("orgs")
}

model OrgHealthSnapshot {
  id         String   @id @default(uuid()) @db.Uuid
  orgId      String   @map("org_id") @db.Uuid
  score      Int
  breakdown  Json
  computedAt DateTime @default(now()) @map("computed_at")
  dateKey    String   @map("date_key")

  org        Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, dateKey])
  @@index([orgId, computedAt])
  @@map("org_health_snapshots")
}

model User {
  id            String        @id @default(uuid()) @db.Uuid
  orgId         String        @map("org_id") @db.Uuid
  name          String
  email         String        @unique
  passwordHash  String        @map("password_hash")
  role          Role
  isActive      Boolean       @default(true) @map("is_active")
  createdAt     DateTime      @default(now()) @map("created_at")
  org           Org           @relation(fields: [orgId], references: [id], onDelete: Cascade)
  activityLogs  ActivityLog[] @relation("ActivityActor")
  ownedCompanies Company[]    @relation("CompanyOwner")
  ownedContacts  Contact[]    @relation("ContactOwner")
  ownedLeads     Lead[]       @relation("LeadOwner")
  ownedDeals     Deal[]       @relation("DealOwner")
  assignedWorkItems WorkItem[] @relation("WorkItemAssignee")
  createdWorkItems  WorkItem[] @relation("WorkItemCreator")
  createdInvoices   Invoice[]   @relation("InvoiceCreator")
  lockedInvoices    Invoice[]   @relation("InvoiceLocker")
  createdNudges     Nudge[]     @relation("NudgeCreator")
  targetNudges      Nudge[]     @relation("NudgeTarget")
  refreshTokens     RefreshToken[]
  securityEvents    SecurityEvent[]

  @@index([orgId])
  @@map("users")
}

model SecurityEvent {
  id          String    @id @default(uuid()) @db.Uuid
  orgId       String    @map("org_id") @db.Uuid
  type        String
  severity    String
  description String
  entityType  String?   @map("entity_type")
  entityId    String?   @map("entity_id")
  userId      String?   @map("user_id") @db.Uuid
  meta        Json?
  resolvedAt  DateTime? @map("resolved_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  org         Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([orgId, severity, createdAt])
  @@map("security_events")
}

model Policy {
  id                                    String   @id @default(uuid()) @db.Uuid
  orgId                                 String   @map("org_id") @db.Uuid
  lockInvoiceOnSent                     Boolean  @default(true) @map("lock_invoice_on_sent")
  overdueAfterDays                      Int      @default(0) @map("overdue_after_days")
  defaultWorkDueDays                    Int      @default(3) @map("default_work_due_days")
  staleDealAfterDays                    Int      @default(7) @map("stale_deal_after_days")
  leadStaleAfterHours                   Int      @default(72) @map("lead_stale_after_hours")
  requireDealOwner                      Boolean  @default(true) @map("require_deal_owner")
  requireWorkOwner                      Boolean  @default(true) @map("require_work_owner")
  requireWorkDueDate                    Boolean  @default(true) @map("require_work_due_date")
  autoLockInvoiceAfterDays              Int      @default(2) @map("auto_lock_invoice_after_days")
  preventInvoiceUnlockAfterPartialPayment Boolean @default(true) @map("prevent_invoice_unlock_after_partial_payment")
  autopilotEnabled                      Boolean  @default(false) @map("autopilot_enabled")
  autopilotCreateWorkOnDealStageChange  Boolean  @default(true) @map("autopilot_create_work_on_deal_stage_change")
  autopilotNudgeOnOverdue               Boolean  @default(true) @map("autopilot_nudge_on_overdue")
  autopilotAutoStaleDeals               Boolean  @default(true) @map("autopilot_auto_stale_deals")
  createdAt                             DateTime @default(now()) @map("created_at")
  updatedAt                             DateTime @updatedAt @map("updated_at")
  org                                   Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId])
  @@map("policies")
}

model ActivityLog {
  id          String           @id @default(uuid()) @db.Uuid
  orgId       String           @map("org_id") @db.Uuid
  actorUserId String?          @map("actor_user_id") @db.Uuid
  entityType  ActivityEntityType @map("entity_type")
  entityId    String           @map("entity_id")
  action      String
  beforeJson  Json?            @map("before_json")
  afterJson   Json?            @map("after_json")
  createdAt   DateTime         @default(now()) @map("created_at")
  org         Org              @relation(fields: [orgId], references: [id], onDelete: Cascade)
  actorUser   User?            @relation("ActivityActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([orgId])
  @@index([actorUserId])
  @@map("activity_logs")
}

model Company {
  id          String    @id @default(uuid()) @db.Uuid
  orgId       String    @map("org_id") @db.Uuid
  name        String
  industry    String?
  website     String?
  ownerUserId String?   @map("owner_user_id") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at")
  org         Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  owner       User?     @relation("CompanyOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)
  contacts    Contact[]
  leads       Lead[]
  deals       Deal[]
  workItems   WorkItem[]
  invoices    Invoice[]

  @@index([orgId])
  @@unique([orgId, name])
  @@map("companies")
}

model Contact {
  id          String    @id @default(uuid()) @db.Uuid
  orgId       String    @map("org_id") @db.Uuid
  companyId   String    @map("company_id") @db.Uuid
  name        String
  email       String?
  phone       String?
  title       String?
  ownerUserId String?   @map("owner_user_id") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at")
  org         Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  owner       User?     @relation("ContactOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)
  leads       Lead[]

  @@index([orgId])
  @@index([companyId])
  @@map("contacts")
}

model Lead {
  id          String    @id @default(uuid()) @db.Uuid
  orgId       String    @map("org_id") @db.Uuid
  title       String
  stage       LeadStage @default(NEW)
  source      String?
  notes       String?
  companyId   String?   @map("company_id") @db.Uuid
  contactId   String?   @map("contact_id") @db.Uuid
  ownerUserId String?   @map("owner_user_id") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at")
  org         Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  company     Company?  @relation(fields: [companyId], references: [id], onDelete: SetNull)
  contact     Contact?  @relation(fields: [contactId], references: [id], onDelete: SetNull)
  owner       User?     @relation("LeadOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)

  @@index([orgId])
  @@index([orgId, stage])
  @@map("leads")
}

model Deal {
  id                String    @id @default(uuid()) @db.Uuid
  orgId             String    @map("org_id") @db.Uuid
  title             String
  stage             DealStage @default(OPEN)
  isStale           Boolean   @default(false) @map("is_stale")
  valueAmount       Int       @default(0) @map("value_amount")
  currency          String    @default("INR")
  expectedCloseDate DateTime? @map("expected_close_date")
  wonAt             DateTime? @map("won_at")
  companyId         String    @map("company_id") @db.Uuid
  ownerUserId       String?   @map("owner_user_id") @db.Uuid
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  org               Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  owner             User?     @relation("DealOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)
  workItems         WorkItem[]
  invoices          Invoice[]

  @@index([orgId])
  @@index([orgId, stage])
  @@index([companyId])
  @@map("deals")
}

model WorkItem {
  id              String         @id @default(uuid()) @db.Uuid
  orgId           String         @map("org_id") @db.Uuid
  title           String
  description     String?
  status          WorkItemStatus @default(TODO)
  priority        Int            @default(2)
  dueDate         DateTime?      @map("due_date") @db.Date
  assignedToUserId String?       @map("assigned_to_user_id") @db.Uuid
  createdByUserId String         @map("created_by_user_id") @db.Uuid
  companyId       String?        @map("company_id") @db.Uuid
  dealId          String?        @map("deal_id") @db.Uuid
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  completedAt     DateTime?      @map("completed_at")

  org             Org            @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assignedToUser  User?          @relation("WorkItemAssignee", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  createdByUser   User           @relation("WorkItemCreator", fields: [createdByUserId], references: [id], onDelete: Restrict)
  company         Company?       @relation(fields: [companyId], references: [id], onDelete: SetNull)
  deal            Deal?          @relation(fields: [dealId], references: [id], onDelete: SetNull)

  @@index([orgId, status])
  @@index([orgId, assignedToUserId])
  @@index([orgId, dueDate])
  @@map("work_items")
}

model Invoice {
  id              String       @id @default(uuid()) @db.Uuid
  orgId           String       @map("org_id") @db.Uuid
  invoiceNumber   String?      @map("invoice_number")
  companyId       String       @map("company_id") @db.Uuid
  dealId          String?      @map("deal_id") @db.Uuid
  status          InvoiceStatus @default(DRAFT)
  amount          Decimal      @db.Decimal(12, 2)
  currency        String       @default("INR")
  issueDate       DateTime     @default(now()) @map("issue_date") @db.Date
  dueDate         DateTime     @map("due_date") @db.Date
  sentAt          DateTime?    @map("sent_at")
  lockAt          DateTime?    @map("lock_at")
  lockedAt        DateTime?    @map("locked_at")
  lockedByUserId  String?      @map("locked_by_user_id") @db.Uuid
  createdByUserId String       @map("created_by_user_id") @db.Uuid
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  org             Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  company         Company      @relation(fields: [companyId], references: [id], onDelete: Restrict)
  deal            Deal?        @relation(fields: [dealId], references: [id], onDelete: SetNull)
  lockedByUser    User?        @relation("InvoiceLocker", fields: [lockedByUserId], references: [id], onDelete: SetNull)
  createdByUser   User         @relation("InvoiceCreator", fields: [createdByUserId], references: [id], onDelete: Restrict)

  @@index([orgId, status])
  @@index([orgId, dueDate])
  @@index([orgId, companyId])
  @@map("invoices")
}

model Nudge {
  id              String             @id @default(uuid()) @db.Uuid
  orgId           String             @map("org_id") @db.Uuid
  createdByUserId String             @map("created_by_user_id") @db.Uuid
  targetUserId    String             @map("target_user_id") @db.Uuid
  type            NudgeType          @default(MANUAL)
  entityType      ActivityEntityType @map("entity_type")
  entityId        String             @map("entity_id")
  message         String
  status          NudgeStatus        @default(OPEN)
  severity        NudgeSeverity      @default(MEDIUM)
  priorityScore   Int                @default(0) @map("priority_score")
  meta            Json?
  actionType      String?            @map("action_type")
  actionPayload   Json?              @map("action_payload")
  executedAt      DateTime?          @map("executed_at")
  undoExpiresAt   DateTime?          @map("undo_expires_at")
  undoData        Json?              @map("undo_data")
  createdAt       DateTime           @default(now()) @map("created_at")
  resolvedAt      DateTime?          @map("resolved_at")

  org             Org                @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdByUser   User               @relation("NudgeCreator", fields: [createdByUserId], references: [id], onDelete: Restrict)
  targetUser      User               @relation("NudgeTarget", fields: [targetUserId], references: [id], onDelete: Restrict)

  @@index([orgId, targetUserId, status])
  @@index([orgId, status, priorityScore])
  @@index([orgId, type, entityType, entityId, status])
  @@map("nudges")
}

model RefreshToken {
  id                String       @id @default(uuid()) @db.Uuid
  orgId             String       @map("org_id") @db.Uuid
  userId            String       @map("user_id") @db.Uuid
  tokenHash         String       @unique @map("token_hash")
  createdAt         DateTime     @default(now()) @map("created_at")
  expiresAt         DateTime     @map("expires_at")
  revokedAt         DateTime?    @map("revoked_at")
  replacedByTokenId String?      @map("replaced_by_token_id") @db.Uuid

  org               Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  replacedByToken   RefreshToken? @relation("RefreshTokenReplacement", fields: [replacedByTokenId], references: [id], onDelete: SetNull)
  replacesTokens    RefreshToken[] @relation("RefreshTokenReplacement")

  @@index([userId, expiresAt])
  @@map("refresh_tokens")
}
