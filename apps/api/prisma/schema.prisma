generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  CEO
  OPS
  SALES
  FINANCE
  ADMIN
}

enum ActivityEntityType {
  AUTH
  USER
  POLICY
  PORTFOLIO
  APP
  API_TOKEN
  AI_INSIGHT
  AI_ACTION
  COMPANY
  CONTACT
  LEAD
  DEAL
  WORK_ITEM
  INVOICE
}

enum LeadStage {
  NEW
  QUALIFIED
  DISQUALIFIED
}

enum DealStage {
  OPEN
  WON
  LOST
}

enum WorkItemStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  DONE
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
}

enum NudgeStatus {
  OPEN
  RESOLVED
}

enum NudgeType {
  MANUAL
  OVERDUE_INVOICE
  OVERDUE_WORK
  STALE_DEAL
}

enum NudgeSeverity {
  MEDIUM
  HIGH
  CRITICAL
}

model Org {
  id           String        @id @default(uuid()) @db.Uuid
  name         String
  createdAt    DateTime      @default(now()) @map("created_at")
  users        User[]
  policies     Policy[]
  activityLogs ActivityLog[]
  companies    Company[]
  contacts     Contact[]
  leads        Lead[]
  deals        Deal[]
  workItems    WorkItem[]
  invoices     Invoice[]
  nudges       Nudge[]
  refreshTokens RefreshToken[]
  healthSnapshots OrgHealthSnapshot[]
  securityEvents SecurityEvent[]
  portfolioGroups OrgGroupOrg[]
  members      OrgMember[]
  inviteTokens OrgInviteToken[]
  subscription Subscription?
  apiTokens    ApiToken[]
  aiInsights   AIInsight[]
  aiActions    AIAction[]
  llmReports   LLMReport[]
  webhookEndpoints WebhookEndpoint[]
  webhookDeliveries WebhookDelivery[]
  appInstalls  OrgAppInstall[]
  appCommandLogs AppCommandLog[]

  @@map("orgs")
}

model WebhookEndpoint {
  id            String    @id @default(uuid()) @db.Uuid
  orgId         String    @map("org_id") @db.Uuid
  url           String
  secret        String
  events        Json
  isActive      Boolean   @default(true) @map("is_active")
  lastFailureAt DateTime? @map("last_failure_at")
  failureCount  Int       @default(0) @map("failure_count")
  createdAt     DateTime  @default(now()) @map("created_at")

  org           Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deliveries    WebhookDelivery[]

  @@index([orgId])
  @@map("webhook_endpoints")
}

model WebhookDelivery {
  id                  String    @id @default(uuid()) @db.Uuid
  orgId               String    @map("org_id") @db.Uuid
  endpointId          String    @map("endpoint_id") @db.Uuid
  event               String
  statusCode          Int?      @map("status_code")
  success             Boolean
  error               String?
  durationMs          Int       @map("duration_ms")
  requestBodyHash     String    @map("request_body_hash")
  responseBodySnippet String?   @map("response_body_snippet")
  attempt             Int
  createdAt           DateTime  @default(now()) @map("created_at")

  org                 Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  endpoint            WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  @@index([orgId, createdAt])
  @@index([endpointId, createdAt])
  @@map("webhook_deliveries")
}

model Plan {
  id                          String   @id @default(uuid()) @db.Uuid
  key                         String   @unique
  name                        String
  priceMonthly                Int      @default(0) @map("price_monthly")
  seatLimit                   Int?     @map("seat_limit")
  orgLimit                    Int?     @map("org_limit")
  autopilotEnabled            Boolean  @default(false) @map("autopilot_enabled")
  shieldEnabled               Boolean  @default(false) @map("shield_enabled")
  portfolioEnabled            Boolean  @default(false) @map("portfolio_enabled")
  revenueIntelligenceEnabled  Boolean  @default(false) @map("revenue_intelligence_enabled")
  enterpriseControlsEnabled   Boolean  @default(false) @map("enterprise_controls_enabled")
  developerPlatformEnabled    Boolean  @default(false) @map("developer_platform_enabled")
  maxWorkItems                Int?     @map("max_work_items")
  maxInvoices                 Int?     @map("max_invoices")
  createdAt                   DateTime @default(now()) @map("created_at")
  subscriptions               Subscription[]

  @@map("plans")
}

model Subscription {
  id                    String   @id @default(uuid()) @db.Uuid
  orgId                 String   @unique @map("org_id") @db.Uuid
  planId                String   @map("plan_id") @db.Uuid
  status                String   @default("TRIAL")
  razorpayCustomerId    String?  @map("razorpay_customer_id")
  razorpaySubscriptionId String? @map("razorpay_subscription_id")
  trialEndsAt           DateTime? @map("trial_ends_at")
  currentPeriodEnd      DateTime? @map("current_period_end")
  createdAt             DateTime @default(now()) @map("created_at")
  org                   Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  plan                  Plan     @relation(fields: [planId], references: [id], onDelete: Restrict)

  @@index([planId])
  @@index([status])
  @@map("subscriptions")
}

model OrgHealthSnapshot {
  id         String   @id @default(uuid()) @db.Uuid
  orgId      String   @map("org_id") @db.Uuid
  score      Int
  breakdown  Json
  computedAt DateTime @default(now()) @map("computed_at")
  dateKey    String   @map("date_key")

  org        Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, dateKey])
  @@index([orgId, computedAt])
  @@map("org_health_snapshots")
}

model User {
  id            String        @id @default(uuid()) @db.Uuid
  orgId         String        @map("org_id") @db.Uuid
  name          String
  email         String        @unique
  passwordHash  String        @map("password_hash")
  role          Role
  isActive      Boolean       @default(true) @map("is_active")
  createdAt     DateTime      @default(now()) @map("created_at")
  org           Org           @relation(fields: [orgId], references: [id], onDelete: Cascade)
  activityLogs  ActivityLog[] @relation("ActivityActor")
  ownedCompanies Company[]    @relation("CompanyOwner")
  ownedContacts  Contact[]    @relation("ContactOwner")
  ownedLeads     Lead[]       @relation("LeadOwner")
  ownedDeals     Deal[]       @relation("DealOwner")
  assignedWorkItems WorkItem[] @relation("WorkItemAssignee")
  createdWorkItems  WorkItem[] @relation("WorkItemCreator")
  createdInvoices   Invoice[]   @relation("InvoiceCreator")
  lockedInvoices    Invoice[]   @relation("InvoiceLocker")
  createdNudges     Nudge[]     @relation("NudgeCreator")
  targetNudges      Nudge[]     @relation("NudgeTarget")
  refreshTokens     RefreshToken[]
  securityEvents    SecurityEvent[]
  ownedOrgGroups    OrgGroup[]       @relation("OrgGroupOwner")
  orgGroupMembers   OrgGroupMember[]
  orgMemberships    OrgMember[]      @relation("OrgMemberUser")
  sentOrgInvites    OrgInviteToken[] @relation("OrgInviteInviter")
  installedApps     OrgAppInstall[]  @relation("OrgAppInstalledBy")

  @@index([orgId])
  @@map("users")
}

model MarketplaceApp {
  id            String   @id @default(uuid()) @db.Uuid
  key           String   @unique
  name          String
  description   String
  developerName String?  @map("developer_name")
  websiteUrl    String?  @map("website_url")
  iconUrl       String?  @map("icon_url")
  category      String?
  scopes        Json?
  webhookEvents Json?    @map("webhook_events")
  oauthProvider String?  @map("oauth_provider")
  isPublished   Boolean  @default(false) @map("is_published")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  installs      OrgAppInstall[]

  @@index([isPublished])
  @@index([category])
  @@map("marketplace_apps")
}

model OrgAppInstall {
  id                String    @id @default(uuid()) @db.Uuid
  orgId             String    @map("org_id") @db.Uuid
  appId             String    @map("app_id") @db.Uuid
  status            String    @default("INSTALLED")
  installedByUserId String?   @map("installed_by_user_id") @db.Uuid
  installedAt       DateTime  @default(now()) @map("installed_at")
  disabledAt        DateTime? @map("disabled_at")
  uninstalledAt     DateTime? @map("uninstalled_at")
  configEncrypted   String?   @map("config_encrypted")
  configVersion     Int       @default(1) @map("config_version")
  secretHash        String?   @map("secret_hash")
  secretEncrypted   String?   @map("secret_encrypted")
  lastUsedAt        DateTime? @map("last_used_at")
  oauthProvider     String?   @map("oauth_provider")
  oauthAccessTokenEncrypted String? @map("oauth_access_token_encrypted")
  oauthRefreshTokenEncrypted String? @map("oauth_refresh_token_encrypted")
  oauthExpiresAt    DateTime? @map("oauth_expires_at")
  oauthScope        String?   @map("oauth_scope")
  oauthAccountId    String?   @map("oauth_account_id")

  org               Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  app               MarketplaceApp @relation(fields: [appId], references: [id], onDelete: Cascade)
  installedByUser   User?     @relation("OrgAppInstalledBy", fields: [installedByUserId], references: [id], onDelete: SetNull)
  commandLogs       AppCommandLog[]

  @@unique([orgId, appId])
  @@index([orgId, status])
  @@index([appId])
  @@map("org_app_installs")
}

model AppCommandLog {
  id              String   @id @default(uuid()) @db.Uuid
  orgId           String   @map("org_id") @db.Uuid
  appInstallId    String   @map("app_install_id") @db.Uuid
  command         String
  idempotencyKey  String   @map("idempotency_key")
  success         Boolean
  statusCode      Int      @map("status_code")
  error           String?
  requestHash     String   @map("request_hash")
  responseSnippet String?  @map("response_snippet")
  createdAt       DateTime @default(now()) @map("created_at")

  org             Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  appInstall      OrgAppInstall @relation(fields: [appInstallId], references: [id], onDelete: Cascade)

  @@unique([orgId, appInstallId, idempotencyKey])
  @@index([orgId, createdAt])
  @@index([appInstallId, createdAt])
  @@map("app_command_logs")
}

model SecurityEvent {
  id          String    @id @default(uuid()) @db.Uuid
  orgId       String    @map("org_id") @db.Uuid
  type        String
  severity    String
  description String
  entityType  String?   @map("entity_type")
  entityId    String?   @map("entity_id")
  userId      String?   @map("user_id") @db.Uuid
  meta        Json?
  resolvedAt  DateTime? @map("resolved_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  org         Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([orgId, severity, createdAt])
  @@index([orgId, resolvedAt])
  @@map("security_events")
}

model OrgMember {
  id        String   @id @default(uuid()) @db.Uuid
  orgId     String   @map("org_id") @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  email     String
  role      Role
  status    String   @default("ACTIVE")
  joinedAt  DateTime? @map("joined_at")
  createdAt DateTime @default(now()) @map("created_at")

  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user      User?    @relation("OrgMemberUser", fields: [userId], references: [id], onDelete: SetNull)

  @@unique([orgId, email])
  @@index([orgId, status])
  @@index([userId])
  @@index([userId, status])
  @@map("org_members")
}

model OrgInviteToken {
  id              String   @id @default(uuid()) @db.Uuid
  orgId           String   @map("org_id") @db.Uuid
  email           String
  role            Role
  tokenHash       String   @map("token_hash")
  invitedByUserId String   @map("invited_by_user_id") @db.Uuid
  expiresAt       DateTime @map("expires_at")
  usedAt          DateTime? @map("used_at")
  createdAt       DateTime @default(now()) @map("created_at")

  org             Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  invitedByUser   User     @relation("OrgInviteInviter", fields: [invitedByUserId], references: [id], onDelete: Restrict)

  @@index([orgId, email])
  @@index([expiresAt])
  @@index([usedAt])
  @@map("org_invite_tokens")
}

model OrgGroup {
  id          String           @id @default(uuid()) @db.Uuid
  name        String
  ownerUserId String           @map("owner_user_id") @db.Uuid
  createdAt   DateTime         @default(now()) @map("created_at")

  owner       User             @relation("OrgGroupOwner", fields: [ownerUserId], references: [id], onDelete: Cascade)
  members     OrgGroupMember[]
  orgs        OrgGroupOrg[]

  @@index([ownerUserId])
  @@map("org_groups")
}

model OrgGroupMember {
  id        String   @id @default(uuid()) @db.Uuid
  groupId   String   @map("group_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      String   @default("OWNER")
  createdAt DateTime @default(now()) @map("created_at")

  group     OrgGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([userId])
  @@index([groupId])
  @@map("org_group_members")
}

model OrgGroupOrg {
  id        String   @id @default(uuid()) @db.Uuid
  groupId   String   @map("group_id") @db.Uuid
  orgId     String   @map("org_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  group     OrgGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([groupId, orgId])
  @@index([groupId])
  @@index([orgId])
  @@map("org_group_orgs")
}

model Policy {
  id                                    String   @id @default(uuid()) @db.Uuid
  orgId                                 String   @map("org_id") @db.Uuid
  lockInvoiceOnSent                     Boolean  @default(true) @map("lock_invoice_on_sent")
  overdueAfterDays                      Int      @default(0) @map("overdue_after_days")
  defaultWorkDueDays                    Int      @default(3) @map("default_work_due_days")
  staleDealAfterDays                    Int      @default(7) @map("stale_deal_after_days")
  leadStaleAfterHours                   Int      @default(72) @map("lead_stale_after_hours")
  requireDealOwner                      Boolean  @default(true) @map("require_deal_owner")
  requireWorkOwner                      Boolean  @default(true) @map("require_work_owner")
  requireWorkDueDate                    Boolean  @default(true) @map("require_work_due_date")
  autoLockInvoiceAfterDays              Int      @default(2) @map("auto_lock_invoice_after_days")
  preventInvoiceUnlockAfterPartialPayment Boolean @default(true) @map("prevent_invoice_unlock_after_partial_payment")
  autopilotEnabled                      Boolean  @default(false) @map("autopilot_enabled")
  autopilotCreateWorkOnDealStageChange  Boolean  @default(true) @map("autopilot_create_work_on_deal_stage_change")
  autopilotNudgeOnOverdue               Boolean  @default(true) @map("autopilot_nudge_on_overdue")
  autopilotAutoStaleDeals               Boolean  @default(true) @map("autopilot_auto_stale_deals")
  auditRetentionDays                    Int      @default(180) @map("audit_retention_days")
  securityEventRetentionDays            Int      @default(180) @map("security_event_retention_days")
  ipAllowlist                           Json?    @map("ip_allowlist")
  ipRestrictionEnabled                  Boolean  @default(false) @map("ip_restriction_enabled")
  createdAt                             DateTime @default(now()) @map("created_at")
  updatedAt                             DateTime @updatedAt @map("updated_at")
  org                                   Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId])
  @@map("policies")
}

model ActivityLog {
  id          String           @id @default(uuid()) @db.Uuid
  orgId       String           @map("org_id") @db.Uuid
  actorUserId String?          @map("actor_user_id") @db.Uuid
  entityType  ActivityEntityType @map("entity_type")
  entityId    String           @map("entity_id")
  action      String
  beforeJson  Json?            @map("before_json")
  afterJson   Json?            @map("after_json")
  createdAt   DateTime         @default(now()) @map("created_at")
  org         Org              @relation(fields: [orgId], references: [id], onDelete: Cascade)
  actorUser   User?            @relation("ActivityActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([orgId])
  @@index([orgId, createdAt])
  @@index([orgId, entityType, entityId, createdAt])
  @@index([actorUserId])
  @@map("activity_logs")
}

model Company {
  id          String    @id @default(uuid()) @db.Uuid
  orgId       String    @map("org_id") @db.Uuid
  name        String
  industry    String?
  website     String?
  ownerUserId String?   @map("owner_user_id") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at")
  org         Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  owner       User?     @relation("CompanyOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)
  contacts    Contact[]
  leads       Lead[]
  deals       Deal[]
  workItems   WorkItem[]
  invoices    Invoice[]

  @@index([orgId])
  @@unique([orgId, name])
  @@map("companies")
}

model Contact {
  id          String    @id @default(uuid()) @db.Uuid
  orgId       String    @map("org_id") @db.Uuid
  companyId   String    @map("company_id") @db.Uuid
  name        String
  email       String?
  phone       String?
  title       String?
  ownerUserId String?   @map("owner_user_id") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at")
  org         Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  owner       User?     @relation("ContactOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)
  leads       Lead[]

  @@index([orgId])
  @@index([companyId])
  @@map("contacts")
}

model Lead {
  id          String    @id @default(uuid()) @db.Uuid
  orgId       String    @map("org_id") @db.Uuid
  title       String
  stage       LeadStage @default(NEW)
  source      String?
  notes       String?
  companyId   String?   @map("company_id") @db.Uuid
  contactId   String?   @map("contact_id") @db.Uuid
  ownerUserId String?   @map("owner_user_id") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at")
  org         Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  company     Company?  @relation(fields: [companyId], references: [id], onDelete: SetNull)
  contact     Contact?  @relation(fields: [contactId], references: [id], onDelete: SetNull)
  owner       User?     @relation("LeadOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)

  @@index([orgId])
  @@index([orgId, createdAt])
  @@index([orgId, stage])
  @@map("leads")
}

model Deal {
  id                String    @id @default(uuid()) @db.Uuid
  orgId             String    @map("org_id") @db.Uuid
  title             String
  stage             DealStage @default(OPEN)
  isStale           Boolean   @default(false) @map("is_stale")
  valueAmount       Int       @default(0) @map("value_amount")
  currency          String    @default("INR")
  expectedCloseDate DateTime? @map("expected_close_date")
  wonAt             DateTime? @map("won_at")
  companyId         String    @map("company_id") @db.Uuid
  ownerUserId       String?   @map("owner_user_id") @db.Uuid
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  org               Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  owner             User?     @relation("DealOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)
  workItems         WorkItem[]
  invoices          Invoice[]

  @@index([orgId])
  @@index([orgId, stage])
  @@index([orgId, createdAt])
  @@index([orgId, updatedAt])
  @@index([orgId, isStale])
  @@index([companyId])
  @@map("deals")
}

model WorkItem {
  id              String         @id @default(uuid()) @db.Uuid
  orgId           String         @map("org_id") @db.Uuid
  title           String
  description     String?
  status          WorkItemStatus @default(TODO)
  priority        Int            @default(2)
  dueDate         DateTime?      @map("due_date") @db.Date
  assignedToUserId String?       @map("assigned_to_user_id") @db.Uuid
  createdByUserId String         @map("created_by_user_id") @db.Uuid
  companyId       String?        @map("company_id") @db.Uuid
  dealId          String?        @map("deal_id") @db.Uuid
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  completedAt     DateTime?      @map("completed_at")

  org             Org            @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assignedToUser  User?          @relation("WorkItemAssignee", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  createdByUser   User           @relation("WorkItemCreator", fields: [createdByUserId], references: [id], onDelete: Restrict)
  company         Company?       @relation(fields: [companyId], references: [id], onDelete: SetNull)
  deal            Deal?          @relation(fields: [dealId], references: [id], onDelete: SetNull)

  @@index([orgId, status])
  @@index([orgId, assignedToUserId])
  @@index([orgId, dueDate])
  @@index([orgId, createdAt])
  @@map("work_items")
}

model Invoice {
  id              String       @id @default(uuid()) @db.Uuid
  orgId           String       @map("org_id") @db.Uuid
  invoiceNumber   String?      @map("invoice_number")
  companyId       String       @map("company_id") @db.Uuid
  dealId          String?      @map("deal_id") @db.Uuid
  status          InvoiceStatus @default(DRAFT)
  amount          Decimal      @db.Decimal(12, 2)
  currency        String       @default("INR")
  issueDate       DateTime     @default(now()) @map("issue_date") @db.Date
  dueDate         DateTime     @map("due_date") @db.Date
  sentAt          DateTime?    @map("sent_at")
  lockAt          DateTime?    @map("lock_at")
  lockedAt        DateTime?    @map("locked_at")
  lockedByUserId  String?      @map("locked_by_user_id") @db.Uuid
  createdByUserId String       @map("created_by_user_id") @db.Uuid
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  org             Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  company         Company      @relation(fields: [companyId], references: [id], onDelete: Restrict)
  deal            Deal?        @relation(fields: [dealId], references: [id], onDelete: SetNull)
  lockedByUser    User?        @relation("InvoiceLocker", fields: [lockedByUserId], references: [id], onDelete: SetNull)
  createdByUser   User         @relation("InvoiceCreator", fields: [createdByUserId], references: [id], onDelete: Restrict)

  @@index([orgId, status])
  @@index([orgId, dueDate])
  @@index([orgId, lockAt])
  @@index([orgId, createdAt])
  @@index([orgId, companyId])
  @@map("invoices")
}

model Nudge {
  id              String             @id @default(uuid()) @db.Uuid
  orgId           String             @map("org_id") @db.Uuid
  createdByUserId String             @map("created_by_user_id") @db.Uuid
  targetUserId    String             @map("target_user_id") @db.Uuid
  type            NudgeType          @default(MANUAL)
  entityType      ActivityEntityType @map("entity_type")
  entityId        String             @map("entity_id")
  message         String
  status          NudgeStatus        @default(OPEN)
  severity        NudgeSeverity      @default(MEDIUM)
  priorityScore   Int                @default(0) @map("priority_score")
  meta            Json?
  actionType      String?            @map("action_type")
  actionPayload   Json?              @map("action_payload")
  executedAt      DateTime?          @map("executed_at")
  undoExpiresAt   DateTime?          @map("undo_expires_at")
  undoData        Json?              @map("undo_data")
  createdAt       DateTime           @default(now()) @map("created_at")
  resolvedAt      DateTime?          @map("resolved_at")

  org             Org                @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdByUser   User               @relation("NudgeCreator", fields: [createdByUserId], references: [id], onDelete: Restrict)
  targetUser      User               @relation("NudgeTarget", fields: [targetUserId], references: [id], onDelete: Restrict)

  @@index([orgId, targetUserId, status])
  @@index([orgId, status, priorityScore])
  @@index([orgId, type, entityType, entityId, status])
  @@map("nudges")
}

model RefreshToken {
  id                String       @id @default(uuid()) @db.Uuid
  orgId             String       @map("org_id") @db.Uuid
  userId            String       @map("user_id") @db.Uuid
  tokenHash         String       @unique @map("token_hash")
  createdAt         DateTime     @default(now()) @map("created_at")
  expiresAt         DateTime     @map("expires_at")
  revokedAt         DateTime?    @map("revoked_at")
  replacedByTokenId String?      @map("replaced_by_token_id") @db.Uuid

  org               Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  replacedByToken   RefreshToken? @relation("RefreshTokenReplacement", fields: [replacedByTokenId], references: [id], onDelete: SetNull)
  replacesTokens    RefreshToken[] @relation("RefreshTokenReplacement")

  @@index([userId, expiresAt])
  @@map("refresh_tokens")
}

model AIInsight {
  id          String   @id @default(uuid()) @db.Uuid
  orgId       String   @map("org_id") @db.Uuid
  type        String
  severity    String
  scoreImpact Int      @default(0) @map("score_impact")
  title       String
  explanation String
  entityType  String?  @map("entity_type")
  entityId    String?  @map("entity_id")
  meta        Json?
  isResolved  Boolean  @default(false) @map("is_resolved")
  createdAt   DateTime @default(now()) @map("created_at")
  resolvedAt  DateTime? @map("resolved_at")

  org         Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  actions     AIAction[]

  @@index([orgId, severity])
  @@index([orgId, isResolved])
  @@index([orgId, createdAt])
  @@index([orgId, type, isResolved])
  @@map("ai_insights")
}

model AIAction {
  id               String    @id @default(uuid()) @db.Uuid
  orgId            String    @map("org_id") @db.Uuid
  insightId        String?   @map("insight_id") @db.Uuid
  type             String
  status           String    @default("PROPOSED")
  title            String
  rationale        String
  payload          Json
  approvedByUserId String?   @map("approved_by_user_id") @db.Uuid
  approvedAt       DateTime? @map("approved_at")
  executedByUserId String?   @map("executed_by_user_id") @db.Uuid
  executedAt       DateTime? @map("executed_at")
  undoData         Json?     @map("undo_data")
  undoExpiresAt    DateTime? @map("undo_expires_at")
  error            String?
  createdAt        DateTime  @default(now()) @map("created_at")

  org              Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  insight          AIInsight? @relation(fields: [insightId], references: [id], onDelete: SetNull)

  @@index([orgId, status, createdAt])
  @@index([orgId, type])
  @@index([orgId, insightId])
  @@map("ai_actions")
}

model ApiToken {
  id         String    @id @default(uuid()) @db.Uuid
  orgId      String    @map("org_id") @db.Uuid
  name       String
  role       Role      @default(ADMIN)
  tokenHash  String    @unique @map("token_hash")
  scopes     Json?     @map("scopes")
  rateLimitPerHour Int @default(1000) @map("rate_limit_per_hour")
  requestsThisHour Int @default(0) @map("requests_this_hour")
  hourWindowStart DateTime? @map("hour_window_start")
  lastUsedAt DateTime? @map("last_used_at")
  revokedAt  DateTime? @map("revoked_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  org        Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([revokedAt])
  @@map("api_tokens")
}

model LLMReport {
  id          String   @id @default(uuid()) @db.Uuid
  orgId       String   @map("org_id") @db.Uuid
  type        String
  periodStart DateTime? @map("period_start")
  periodEnd   DateTime? @map("period_end")
  inputHash   String   @map("input_hash")
  model       String?
  provider    String?
  contentJson Json     @map("content_json")
  contentText String?  @map("content_text")
  tokensIn    Int?     @map("tokens_in")
  tokensOut   Int?     @map("tokens_out")
  latencyMs   Int?     @map("latency_ms")
  createdAt   DateTime @default(now()) @map("created_at")

  org         Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, type, createdAt])
  @@unique([orgId, type, inputHash])
  @@map("llm_reports")
}
